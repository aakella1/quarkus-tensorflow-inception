<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>TensorQuark</title>
    <link href="/webjars/bootstrap/4.4.1-1/css/bootstrap.min.css" rel="stylesheet">
    <meta name="theme-color" content="#563d7c">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>
    <!-- Custom styles for this template -->
    <link href="album.css" rel="stylesheet">
</head>
<body class="d-flex flex-column h-100">

    <header>
        <div class="navbar navbar-dark bg-dark shadow-sm">
            <div class="container d-flex justify-content-between">
                <span class="navbar-brand d-flex align-items-center">
                    <strong>
                        <img src="tensorflow.png" height="40" style="margin-right:0px">
                        +
                        <img src="quarkus.png" height="40" style="margin-left: 5px; margin-right:10px">
                        TensorQuark
                    </strong>
                </span>
                <span class="my-2 my-lg-0">
                    <strong>
                        <a href="https://www.google.com/imghp?as_st=y&tbm=isch&as_q=&as_epq=&as_oq=&as_eq=&cr=&as_sitesearch=&safe=active&tbs=isz:lt,islt:4mp,itp:photo,ift:jpg" target="_new">Find JPEGs</a>
                    </strong>
                </span>
                <span class="my-2 my-lg-0">
                    <strong><a href="https://www.openshift.com/learn/topics/ai-ml" target="_new" style="color:silver"><span>&#8680;</span> <span>&#8680;</span> <span>&#8680;</span> Learn about AI/ML on OpenShift!</a></strong>
                </span>
            </div>
        </div>
    </header>

    <main role="main">

        <footer class="text-center form-inline justify-content-around" style="padding: 20px; background-color: #242a30">

            <div class="input-group mb-2">
                <form>
                    <input type="file" name="file" id="fileSelect" class="btn btn-primary"/>
                </form>
            </div>

            <div class="mb-2">
            <span style="color: white; font-size: 10pt">
                <span style="font-size: 20pt; color: #007bff">Upload Image File or Submit URL</span><br>
                <a style="color: white; text-decoration: underline" href="https://www.google.com/imghp?as_st=y&tbm=isch&as_q=&as_epq=&as_oq=&as_eq=&cr=&as_sitesearch=&safe=active&tbs=isz:lt,islt:4mp,itp:photo,ift:jpg" target="_new">Try JPEG format</a> of high quality. Compression reduces readability.
            </span>
            </div>
            <div class="input-group mx-sm-3 mb-2">
                <div class="input-group-prepend">
                    <span class="input-group-text">Image URL</span>
                </div>
                <input id="image-url" type="url" class="form-control">
                <div class="input-group-append">
                    <input class="btn btn-primary" type="button" value="Submit" onclick="submitURL()">
                </div>
            </div>

        </footer>

        <div class="album py-5 bg-light">
            <div class="container">
                <div class="card-columns" id="cards">
                </div>
            </div>
        </div>

    </main>

<script src="/webjars/jquery/3.4.1/jquery.min.js"></script>
<script src="/webjars/bootstrap/4.4.1-1/js/bootstrap.min.js"></script>


<script type="text/javascript">

    var cardCount  = 0;

    if (!!window.EventSource) {
        var eventSource = new EventSource("/object/stream");
        eventSource.onmessage = function (event) {
            data = JSON.parse(event.data);
            showResult(data);
        };
    }
    else {
        window.alert("EventSource not available on this browser.")
    }


    function highlightBB(cardCount, bbCount) {
        $('#bb-' + cardCount + '-' + bbCount).css('border','2px solid red');
    }

    function resetBB(cardCount, bbCount) {
        $('#bb-' + cardCount + '-' + bbCount).css('border','2px solid #007bff');
    }

      function doSubmit(){
        var formData = new FormData();

        var fileSelect = document.getElementById("fileSelect");
        if(fileSelect.files && fileSelect.files.length == 1){
         var file = fileSelect.files[0]
         formData.set("file", file , file.name);
        }

        // Http Request
        var request = new XMLHttpRequest();
        request.responseType = "json";

        request.open('POST', "http://localhost:8080/object/detect/" + 65);
        request.setRequestHeader("Accept", "application/json,text/plain");
        request.send(formData);
      }

function showResult(response) {
    var uuid = response.uuid;

    $.get('/object/data?uuid=' + uuid,
      function (data, textStatus, jqXHR) {  // success callback
          if(data.error != null) {
              $("#alert").addClass("show");
          }
          else {
              displayResult(response, data);
          }
    });
}

function displayResult(response, data) {
    var html = '';
    var results = response.results;
    var mediaType = response.mediaType;

    var imageWidth = response.width;
    var imageHeight = response.height;
    var error = response.error;

    if(error != null) return;

    $('#cards').prepend('<div class="card w-300"><div id="card-' + cardCount +'" style="position: relative"></div><div class="card-body" id="card-body-' + cardCount + '"></div></div>');
    $('#card-' + cardCount).append('<img class="card-img-top" width="' + imageWidth + '" src="data:' + mediaType + ';base64,' + data + '">');

    for (var i = 0; i < results.length; i++) {

       var label = results[i].label;
       var score = results[i].score;
       var badgeType = 'primary';
       if(score < 0) {
         badgeType = 'danger';
         score = label;
         label = 'error';
       }
       else {
         score = parseFloat(results[i].score * 100).toFixed(2);
       }

       html += '<span class="badge badge-pill badge-' + badgeType + '" data-toggle="tooltip" data-placement="right" title="' + score + '% Confident" onmouseover="highlightBB(' + cardCount + ',' + i + ')" onmouseout="resetBB(' + cardCount + ',' + i + ')">' + label + '</span> ';

       var x1 = parseFloat(results[i].x1 * 100).toFixed(2);
       var y1 = parseFloat(results[i].y1 * 100).toFixed(2);
       var x2 = parseFloat(results[i].x2 * 100).toFixed(2);
       var y2 = parseFloat(results[i].y2 * 100).toFixed(2);

       boundingWidth = x2 - x1;
       boundingHeight = y2 - y1;

       $('#card-' + cardCount).append('<div id="bb-' + cardCount + '-' + i + '" style="position: absolute; top: ' + y1 + '%; left: ' + x1 + '%; width: ' + boundingWidth + '%; height: ' + boundingHeight + '%; border: 2px solid #007bff"></div>');
    }

    $('#card-body-' + cardCount).html(html);
    cardCount++;
}

    function readURL(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {

        }
        reader.readAsDataURL(input.files[0]);
        doSubmit();
      }
    }
    $("#fileSelect").on('change', function(){
      readURL(this);
    });

    function submitURL() {
        var url =$('#image-url').val();
        if(isURL(url)) {
            $.get('/object/detect?image=' + encodeURI(url),
              function (data, textStatus, jqXHR) {  // success callback
                  if(data.error != null) {
                      var alert = '<div id="alert" class="alert alert-danger alert-fixed alert-dismissible fade show" role="alert"><span>There was an error reading your image. <b>Please try a different one.</b></span><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>';
                      $("body").append(alert);
                  }
                  else {
                      $('#image-url').val("");
                  }
            });
        }
        else {
            alert("Not a valid URL!");
        }
    }

    function isURL(string) {
      var url;

      try {
        url = new URL(string);
      } catch (err) {
        return false;
      }

      return url.protocol === "http:" || url.protocol === "https:";
    }
  </script>

</body>
</html>