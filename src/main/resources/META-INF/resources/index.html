<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Quarkus + TensorFlow Object Recognition</title>
    <link href="/webjars/bootstrap/4.4.1-1/css/bootstrap.min.css" rel="stylesheet">
    <meta name="theme-color" content="#563d7c">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>
    <!-- Custom styles for this template -->
    <link href="album.css" rel="stylesheet">
</head>
<body>
<header>
    <div class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container d-flex justify-content-between">
            <a href="#" class="navbar-brand d-flex align-items-center">
                <strong>Quarkus + TensorFlow Object Recognition</strong>
            </a>
        </div>
    </div>
</header>

<main role="main">

    <section class="text-center" style="padding: 60px; background-color: #242a30">
        <form class="form-inline justify-content-around">
            <div class="input-group mb-2">
                <input type="file" name="file" id="fileSelect" class="btn btn-primary"/>
            </div>
            <div class="mb-2">
                <span style="color: white; font-size: 10pt">
                    <span style="font-size: 20pt; color: #007bff">Upload Image File or Submit URL</span><br>
                    Image must be JPEG (not heavily compressed), PNG, or GIF.
                </span>
            </div>
            <div class="input-group mx-sm-3 mb-2">
                <div class="input-group-prepend">
                    <span class="input-group-text">Image URL</span>
                </div>
                <input id="image-url" type="url" class="form-control">
                <div class="input-group-append">
                    <input class="btn btn-primary" type="button" value="Submit" onclick="submitURL()">
                </div>
            </div>
        </form>

        <div id="alert" class="alert alert-danger alert-fixed alert-dismissible fade" role="alert">
            <span>There was an error reading your image. <b>Please try a different one.</b></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

    </section>

    <div class="album py-5 bg-light">
        <div class="container">
            <div class="card-columns" id="cards">
            </div>
        </div>
    </div>

</main>

<footer class="text-muted">
    <div class="container">
    </div>
</footer>

<script src="/webjars/jquery/3.4.1/jquery.min.js"></script>
<script src="/webjars/bootstrap/4.4.1-1/js/bootstrap.min.js"></script>


<script type="text/javascript">

    var cardCount  = 0;

    if (!!window.EventSource) {
        var eventSource = new EventSource("/object/stream");
        eventSource.onmessage = function (event) {
            data = JSON.parse(event.data);
            showResult(data);
        };
    }
    else {
        window.alert("EventSource not available on this browser.")
    }


    function highlightBB(cardCount, bbCount) {
        $('#bb-' + cardCount + '-' + bbCount).css('border','2px solid red');
    }

    function resetBB(cardCount, bbCount) {
        $('#bb-' + cardCount + '-' + bbCount).css('border','2px solid #007bff');
    }

      function doSubmit(){
        var formData = new FormData();

        var fileSelect = document.getElementById("fileSelect");
        if(fileSelect.files && fileSelect.files.length == 1){
         var file = fileSelect.files[0]
         formData.set("file", file , file.name);
        }

        // Http Request
        var request = new XMLHttpRequest();
        request.responseType = "json";
        request.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                //showResult(this.response);
           }
        }

        request.open('POST', "http://localhost:8080/object/detect/" + 65);
        request.setRequestHeader("Accept", "application/json,text/plain");
        request.send(formData);
      }

function showResult(response) {


    var html = '';
    var results = response.results;
    var mediaType = response.mediaType;
    var base64EncodedData = response.base64EncodedData;
    var imageWidth = response.width;
    var imageHeight = response.height;
    var error = response.error;

    if(error != null) return;

    $('#cards').append('<div class="card w-300"><div id="card-' + cardCount +'" style="position: relative"></div><div class="card-body" id="card-body-' + cardCount + '"></div></div>');
    $('#card-' + cardCount).append('<img class="card-img-top" width="' + imageWidth + '" src="data:' + mediaType + ';base64,' + base64EncodedData + '">');

    for (var i = 0; i < results.length; i++) {

       var label = results[i].label;
       var score = results[i].score;
       var badgeType = 'primary';
       if(score < 0) {
         badgeType = 'danger';
         score = label;
         label = 'error';
       }
       else {
         score = parseFloat(results[i].score * 100).toFixed(2);
       }

       html += '<span class="badge badge-pill badge-' + badgeType + '" data-toggle="tooltip" data-placement="right" title="' + score + '% Confident" onmouseover="highlightBB(' + cardCount + ',' + i + ')" onmouseout="resetBB(' + cardCount + ',' + i + ')">' + label + '</span> ';

       var x1 = parseFloat(results[i].x1 * 100).toFixed(2);
       var y1 = parseFloat(results[i].y1 * 100).toFixed(2);
       var x2 = parseFloat(results[i].x2 * 100).toFixed(2);
       var y2 = parseFloat(results[i].y2 * 100).toFixed(2);

       boundingWidth = x2 - x1;
       boundingHeight = y2 - y1;

       $('#card-' + cardCount).append('<div id="bb-' + cardCount + '-' + i + '" style="position: absolute; top: ' + y1 + '%; left: ' + x1 + '%; width: ' + boundingWidth + '%; height: ' + boundingHeight + '%; border: 2px solid #007bff"></div>');
    }

    $('#card-body-' + cardCount).html(html);
    cardCount++;
}

    function readURL(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {

        }
        reader.readAsDataURL(input.files[0]);
        doSubmit();
      }
    }
    $("#fileSelect").on('change', function(){
      readURL(this);
    });

    function submitURL() {
        var url =$('#image-url').val();
        if(isURL(url)) {
            $.get('/object/detect?image=' + url,
              function (data, textStatus, jqXHR) {  // success callback
                  if(data.error != null) {
                      $("#alert").addClass("show");
                  }
                  else {
                      $('#image-url').val("");
                  }
            });
        }
        else {
            alert("Not a valid URL!");
        }
    }

    function isURL(string) {
      var url;

      try {
        url = new URL(string);
      } catch (err) {
        return false;
      }

      return url.protocol === "http:" || url.protocol === "https:";
    }
  </script>

</body>
</html>